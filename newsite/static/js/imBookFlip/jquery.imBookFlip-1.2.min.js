;(function($){$.fn.imBookFlip=function(pluginOptions){if(this.length>1){this.each(function(){$(this).imBookFlip(pluginOptions)});return this}var imBookFlip=this;var numPages=0;var leftStart=0,rightStart=1;var autoPage=0;var page,book,bW,pageW,pageH,bookOpenW='';var aAudio=new Array();var selectedAudio=0;var pageSelected=-1;var defaults={allowPageClick:true,autoFlip:'off',autoFlipSpeed:7000,goToPageSpeed:500,numPixels:20,pSpeed:'20',page_class:'',sound_manager:'',iframe:'',flipDirection:'ltr'};var opts=$.extend({},defaults,pluginOptions);var initialize=function(){if($.meta){options=$.extend({},opts,this.data())}return imBookFlip};this.create=function(){if(opts.sound_manager){var tf=initSoundManager();if(opts.sound_manager.audio_loc){loadAudio(opts.sound_manager.audio_loc)}else if(opts.sound_manager.page_audio){tf=getPageAudio(opts.sound_manager.page_audio)}}if(opts.iframe.src){loadIFrame()}else{page=$('.'+opts.page_class)[0];init()}};this.flipPage=function(d){if(d=='next'){if(rightStart<numPages){nextPage()}}else{if(leftStart>0){prevPage()}}};this.goToPage=function(pageNum){pageNum=parseInt(pageNum);if((pageNum>=0)&&(pageNum<numPages)){pageSelected=(numberIsEven(pageNum))?pageNum:pageNum+1;if(pageSelected>rightStart){goToNextPage()}else{goToPrevPage()}}};var loadIFrame=function(){var iframe=$('<iframe src="'+opts.iframe.src+'" id="bookFlipIframe" name="bookFlipIframe"  scrolling="no" allowTransparency="true" frameborder="0"></iframe>').css({"width":imBookFlip.width(),"height":imBookFlip.height(),"border":"0px","overflow":"hidden"}).appendTo(imBookFlip);$('#bookFlipIframe').load(function(){book=$('#bookFlipIframe').contents().find('#'+opts.iframe.book);page=$('#bookFlipIframe').contents().find('.'+opts.page_class)[0];init()})};var init=function(){bW=parseInt($(page).css('borderLeftWidth'))+parseInt($(page).css('borderRightWidth'));pageW=parseInt($(page).css('width'))+bW;pageH=parseInt($(page).css('height'))+bW;bookOpenW=pageW*2;if(opts.numPixels>100){opts.numPixels=100};createPages()};var getPageAudio=function(audio){$.each(audio,function(i,itm){aAudio[i]=itm.audio_loc});return true};var initSoundManager=function(){var dbg=false;if(opts.sound_manager.debug){dbg=opts.sound_manager.debug}soundManager.url=opts.sound_manager.swf_loc;soundManager.debugMode=dbg;return true};var loadAudio=function(loc){var ld=(opts.autoFlip!='click');soundManager.onload=function(){soundManager.createSound({id:'imBookAudio'+selectedAudio,url:loc,autoLoad:true,autoPlay:ld})}};var unloadAudio=function(){soundManager.unload('imBookAudio'+selectedAudio)};var createPages=function(){var pages,orig,lft,div,pW;if(opts.iframe.src){$this=$(book);pages=$this.find(' > div')}else{var bk=imBookFlip.attr('id');$this=imBookFlip;pages=$('#'+bk+' > div')}$this.css({'width':(bookOpenW+'px'),'height':pageH+'px','zIndex':0});numPages=$(pages).length;$(pages).each(function(i){orig=$(this).clone();lft=(opts.flipDirection=='ltr')?pageW:0;div=$('<div></div>').attr({'id':'pageNum'+i,'class':opts.page_class}).css({'zIndex':numPages-i,'border':'none','left':lft+'px','width':pageW+'px','height':pageH+'px'});$(this).replaceWith(div);if(numberIsEven(i)){$(div).data("clickEvent",{url:aAudio[i]})}$(orig).attr('id','pageFlip'+i);$(div).append($(orig));if(opts.allowPageClick){$(orig).click(function(){if(opts.flipDirection=='ltr'){if(numberIsEven(i)){soundCheck();nextPage()}else{prevPage()}}else{if(numberIsEven(i)){soundCheck();nextPageRtl()}else{prevPageRtl()}}})}});$this.css('display','block');if(opts.autoFlip=='auto'){if(opts.flipDirection=='ltr'){doAutoFlip()}else{doAutoFlipRtl()}}};var doAutoFlip=function(){if(rightStart<numPages){autoPage=setTimeout(nextPage,opts.autoFlipSpeed)}else{clearTimeout(autoPage)}};var doAutoFlipRtl=function(){if(leftStart>0){autoPage=setTimeout(nextPageRtl,opts.autoFlipSpeed)}else{clearTimeout(autoPage)}};var soundCheck=function(){if((opts.sound_manager)&&(rightStart==1)){if(opts.autoFlip=='click'){soundManager.play('imBookAudio'+selectedAudio)}}};var numberIsEven=function(value){return(1-(value%2))};var nextPage=function(){var page=(opts.iframe.src)?$this.find("#pageNum"+rightStart):$("#pageNum"+rightStart);var lpage=(opts.iframe.src)?$this.find("#pageNum"+leftStart):$("#pageNum"+leftStart);$(page).css({'width':'0px','left':bookOpenW+'px','zIndex':1000});$(page).animate({'left':2+'px','width':pageW+'px'},'slow',function(){$(this).css({'left':'0px','width':pageW+'px','zIndex':0});$(lpage).css({'left':'','right':'0px','width':'0px'});$(this).css({'left':'','right':'0px'});leftStart+=2;rightStart+=2;if(pageSelected!=-1){goToNextPage()}else if(opts.autoFlip!='off'){doAutoFlip()}})};var nextPageRtl=function(){var page=(opts.iframe.src)?$this.find("#pageNum"+rightStart):$("#pageNum"+rightStart);var lpage=(opts.iframe.src)?$this.find("#pageNum"+leftStart):$("#pageNum"+leftStart);$(page).css({'width':'0px','left':'0px','zIndex':1000});$(page).animate({'left':pageW+'px','width':pageW+'px'},'slow',function(){$(lpage).css({'width':'0px','left':'','right':'0px'});$(this).css({'zIndex':0});leftStart+=2;rightStart+=2;if(pageSelected!=-1){goToNextPage()}else if(opts.autoFlip!='off'){doAutoFlipRtl()}})};var prevPage=function(){leftStart-=2;rightStart-=2;var page=(opts.iframe.src)?$this.find("#pageNum"+leftStart):$("#pageNum"+leftStart);var rpage=(opts.iframe.src)?$this.find("#pageNum"+rightStart):$("#pageNum"+rightStart);var pFlipL=(opts.iframe.src)?$this.find("#pageFlip"+leftStart):$("#pageFlip"+leftStart);var pFlipR=(opts.iframe.src)?$this.find("#pageFlip"+rightStart):$("#pageFlip"+rightStart);$(page).css({'width':'0px','left':'0px'});$(pFlipR).css({'left':'','right':'0px'});$(page).animate({'left':pageW+'px','width':pageW+'px'},'slow',function(){$(rpage).css({'width':'0px'});$(pFlipR).css({'left':'0px'});$(pFlipL).css({'left':'0px'})});if(pageSelected!=-1){goToPrevPage()}};var prevPageRtl=function(){leftStart-=2;rightStart-=2;var page=(opts.iframe.src)?$this.find("#pageNum"+rightStart):$("#pageNum"+rightStart);var rpage=(opts.iframe.src)?$this.find("#pageNum"+leftStart):$("#pageNum"+leftStart);var pFlipL=(opts.iframe.src)?$this.find("#pageFlip"+rightStart):$("#pageFlip"+rightStart);var pFlipR=(opts.iframe.src)?$this.find("#pageFlip"+leftStart):$("#pageFlip"+leftStart);$(pFlipR).css({'left':'','right':'0px'});$(page).css('zIndex',1000);$(page).animate({'left':'0px','width':'0px'},'slow',function(){$(rpage).css({'width':pageW+'px'});$(pFlipR).css({'left':'0px'});$(pFlipL).css({'left':'0px'})});if(pageSelected!=-1){goToPrevPage()}};var goToNextPage=function(){if(rightStart<pageSelected){var fn=(opts.flipDirection=='ltr')?nextPage:nextPageRtl;autoPage=setTimeout(fn,opts.goToPageSpeed)}else{clearTimeout(autoPage)}};var goToPrevPage=function(){if(leftStart>pageSelected){var fn=(opts.flipDirection=='ltr')?prevPage:prevPageRtl;autoPage=setTimeout(fn,opts.goToPageSpeed)}else{clearTimeout(autoPage)}};return initialize()}})(jQuery);